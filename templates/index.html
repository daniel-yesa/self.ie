<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<head>
    <title>Self.ie - Self Install Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
            font-size: 16px !important;
        }

        h1 {
            text-align: center;
            color: #1a73e8;
            font-weight: 700;
        }

        .upload-form {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            max-width: 600px;
            margin: 0 auto 24px auto;
        }

        label {
            display: inline-block;
            margin: 8px 0 4px;
            font-weight: 600;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        button[type="submit"] {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .error {
            color: #b91c1c;
            background: #fee2e2;
            border: 1px solid #fecaca;
            padding: 10px;
            border-radius: 8px;
            max-width: 600px;
            margin: 16px auto;
        }

        .results {
            max-width: 1100px;
            margin: 0 auto;
        }

        .section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 9999px;
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
        }

        .capture-btn {
            display: inline-block;
            background: #0ea5e9;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .spacer {
            height: 8px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note {
            font-size: 12px;
            color: #475569;
        }

        .footer {
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            margin-top: 24px;
        }

        .download-hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
        }

        .relative {
            position: relative;
        }
    </style>
</head>
<body>

<h1>Self.ie - Self Install Report</h1>

<div class="upload-form">
    <form method="POST" enctype="multipart/form-data">
        <label>Raw Self Installs CSV:</label><br>
        <input type="file" name="raw_csv" required><br><br>
        <button type="submit">Generate Report</button>
    </form>
</div>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

{% if report_data %}
<div class="results">

    <!-- SECTION 1: Top Reps -->
    <div class="section" id="section1">
        <div class="section-title">
            <h2>Top Reps</h2>
            <div class="controls">
                <span class="badge">Sorted by Installs</span>
                <a id="captureTop" class="capture-btn">Capture Section</a>
            </div>
        </div>
        <div class="spacer"></div>

        <table>
            <thead>
                <tr>
                    <th>Rep</th>
                    <th>Installs</th>
                </tr>
            </thead>
            <tbody>
                {% for row in report_data.top_reps %}
                <tr>
                    <td>{{ row.Rep }}</td>
                    <td>{{ row.Installs }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="download-hint">You can paste this table into email or Sheets.</div>
    </div>

    <!-- SECTION 2: Zero Installs -->
    <div class="section" id="section2">
        <div class="section-title">
            <h2>Zero Install Reps</h2>
            <a id="captureZero" class="capture-btn">Capture Section</a>
        </div>
        <div class="spacer"></div>

        <table>
            <thead>
                <tr>
                    <th>Rep</th>
                </tr>
            </thead>
            <tbody>
                {% for rep in report_data.zero_reps %}
                <tr>
                    <td>{{ rep }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- SECTION 3: Team Breakdown -->
    <div class="section" id="section3">
        <div class="section-title">
            <h2>Team Breakdown</h2>
            <a id="captureTeam" class="capture-btn">Capture Section</a>
        </div>
        <div class="spacer"></div>

        <div class="grid">
            {% for team in report_data.team_breakdown %}
            <div class="section">
                <h3>{{ team.team }}</h3>
                <p class="note">Manager: <strong>{{ team.manager }}</strong> &nbsp;•&nbsp; Manager Installs: <strong>{{ team.manager_installs }}</strong> &nbsp;•&nbsp; Total: <strong>{{ team.total }}</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Rep</th>
                            <th>Installs</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in team.reps %}
                        <tr>
                            <td>{{ row[report_data.top_reps[0].keys()|list|first] if row.get('Rep') is none else row.Rep }}</td>
                            <td>{{ row.Installs }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="footer">
        Generated by Self.ie
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function captureAndDownload(elementId, filename) {
        const element = document.getElementById(elementId);
        html2canvas(element).then(canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    const capTop = document.getElementById('captureTop');
    if (capTop) {
        capTop.addEventListener('click', function() {
            captureAndDownload('section1', 'top_reps.png');
        });
    }

    const capZero = document.getElementById('captureZero');
    if (capZero) {
        capZero.addEventListener('click', function() {
            captureAndDownload('section2', 'zero_reps.png');
        });
    }

    const capTeam = document.getElementById('captureTeam');
    if (capTeam) {
        capTeam.addEventListener('click', function() {
            const section3 = document.getElementById('section3');
            const section3Clone = section3.cloneNode(true);
            const cards = section3Clone.querySelectorAll('.grid > .section');
            cards.forEach(card => {
                card.style.pageBreakInside = 'avoid';
                card.style.marginBottom = '12px';
            });
            section3Clone.style.background = '#fff';
            section3Clone.style.padding = '20px';
            section3Clone.style.borderRadius = '12px';
            section3Clone.style.boxShadow = 'none';
            section3Clone.style.position = 'relative';
            document.body.appendChild(section3Clone);
            html2canvas(section3Clone).then(canvas => {
                const link = document.createElement('a');
                link.download = 'team_breakdown.png';
                link.href = canvas.toDataURL();
                link.click();
            });
            setTimeout(() => section3Clone.remove(), 500);
        });
    }
});
</script>
{% endif %}

</body>
</html>
